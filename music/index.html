<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VentiStudio Music</title>
  <link rel="stylesheet" href="https://trust.ventistudio.fr/root/style.css">
  <style>
    :root {
      --primary: #7c3aed;
      --dark-bg: #1a1b26;
      --text-light: #fff;
      --led-color: #a78bfa;
      --control-bg: #191a2a;
      --button-hover: #32336a;
      --progress-bg: #2c2d3e;
      --progress-value: #7c3aed;
    }
    body {
      background: var(--dark-bg);
      color: var(--text-light);
      font-family: sans-serif;
      margin: 0;
      padding-bottom: 180px;
    }
    .music-app {
      padding: 2rem;
      max-width: 1200px;
      margin: auto;
    }
    .search-bar {
      margin-bottom: 2rem;
      background: #2b2d42;
      padding: 0.75rem;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(124, 58, 237, 0.3);
    }
    .search-bar input {
      width: 100%;
      padding: 1rem;
      border-radius: 12px;
      border: none;
      font-size: 1.2rem;
      background: #1f1f2e;
      color: #fff;
    }
    .track-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 2rem;
    }
    .track {
      position: relative;
      background: #2a2d3e;
      border-radius: 20px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.3s ease;
      text-align: center;
    }
    .track:hover {
      transform: scale(1.02);
    }
    .track img {
      width: 100%;
      aspect-ratio: 1/1;
      object-fit: cover;
      border-radius: 20px;
      filter: blur(0px);
      transition: filter 0.3s ease;
    }
    .track:hover img {
      filter: blur(2px);
    }
    .track-info {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
      background: rgba(0,0,0,0.3);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .track:hover .track-info {
      opacity: 1;
    }
    .track-info p {
      font-size: 0.9rem;
      margin: 0.2rem 0;
    }
    .track-title {
      margin-top: 0.5rem;
      font-size: 1rem;
      font-weight: bold;
      color: #fff;
    }
    .player-controls {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(17, 24, 39, 0.95);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(124, 58, 237, 0.3);
      padding: 1rem 2rem;
      box-shadow: 0 -10px 25px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .player-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }
    .now-playing {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex: 1;
      min-width: 200px;
      overflow: hidden;
    }
    .album-art {
      width: 52px;
      height: 52px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(124, 58, 237, 0.4);
      overflow: hidden;
      flex-shrink: 0;
      background: #2a2d3e;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    .track-info-player {
      overflow: hidden;
    }
    .track-title-player {
      font-weight: bold;
      font-size: 1rem;
      margin: 0;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .track-artist {
      font-size: 0.85rem;
      margin: 0;
      color: #a78bfa;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .player-main {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      width: 100%;
    }
    .progress-wrapper {
      position: relative;
      height: 5px;
      background: var(--progress-bg);
      border-radius: 10px;
      overflow: hidden;
      cursor: pointer;
      margin-bottom: 5px;
    }
    .progress-bar {
      position: absolute;
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--progress-value), #9f7aea);
      border-radius: 10px;
    }
    .progress-handle {
      position: absolute;
      height: 13px;
      width: 13px;
      background: white;
      border-radius: 50%;
      top: 50%;
      left: 0%;
      transform: translate(-50%, -50%) scale(0);
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      transition: transform 0.2s ease;
    }
    .progress-wrapper:hover .progress-handle {
      transform: translate(-50%, -50%) scale(1);
    }
    .time-display {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: #9f9fa8;
    }
    .player-buttons {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1.5rem;
      margin: 0.5rem 0;
    }
    .player-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }
    .player-volume {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      min-width: 150px;
    }
    .extras {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .btn {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.85;
      transition: all 0.2s ease;
      padding: 0.5rem;
      border-radius: 50%;
    }
    .btn:hover {
      opacity: 1;
      background: var(--button-hover);
      transform: translateY(-2px);
    }
    .btn-sm {
      font-size: 1.15rem;
    }
    .btn-lg {
      font-size: 1.8rem;
    }
    .btn-play {
      background: var(--primary);
      width: 48px;
      height: 48px;
      border-radius: 50%;
      box-shadow: 0 0 15px rgba(124, 58, 237, 0.5);
    }
    .btn-play:hover {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(124, 58, 237, 0.7);
    }
    .btn.active {
      color: var(--primary);
    }
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 4px;
      background: var(--progress-bg);
      border-radius: 10px;
      outline: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      transition: all 0.2s;
    }
    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }
    input[type="range"]::-moz-range-thumb {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    input[type="range"]::-moz-range-thumb:hover {
      transform: scale(1.2);
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.03); }
      100% { transform: scale(1); }
    }
    .now-playing.active .album-art {
      animation: pulse 2s infinite ease-in-out;
    }
    @media (max-width: 768px) {
      .player-controls {
        padding: 1rem;
      }
      .player-top {
        flex-direction: column;
        gap: 1rem;
      }
      .now-playing {
        width: 100%;
      }
      .player-footer {
        flex-direction: column-reverse;
        gap: 1rem;
      }
      .player-volume {
        width: 100%;
      }
      .extras {
        width: 100%;
        justify-content: space-between;
      }
    }
    /* Plein écran LED */
    #fullscreenLed {
      display: none;
      position: fixed;
      z-index: 2000;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: #18192a;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    #fullscreenLed .led-canvas {
      position: absolute;
      top: 0; left: 0; width: 100vw; height: 100vh;
      z-index: 1;
      pointer-events: none;
    }
    #fullscreenLed .led-content {
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    #fullscreenLed .led-album {
      max-width: 320px;
      max-height: 320px;
      border-radius: 20px;
      box-shadow: 0 0 40px #000;
    }
    #fullscreenLed .led-title {
      color: #fff;
      margin: 30px 0 10px 0;
      text-shadow: 0 0 10px #000;
      font-size: 2rem;
    }
    #fullscreenLed .led-artist {
      color: #a78bfa;
      margin: 0 0 30px 0;
      text-shadow: 0 0 10px #000;
      font-size: 1.2rem;
    }
    #fullscreenLed .led-exit {
      margin-top: 30px;
      padding: 10px 30px;
      border-radius: 10px;
      background: #7c3aed;
      color: #fff;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="music-app">
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Rechercher une musique, un artiste, un album...">
    </div>
    <div class="track-list" id="trackList"></div>
    <div style="height: 250px;"></div>
  </div>
  <div class="player-controls">
    <div class="player-top">
      <div class="now-playing active" id="nowPlayingContainer">
        <div class="album-art" id="albumArt">
          <img id="currentAlbumImage" src="/favicon.gif" alt="Album cover" style="width: 100%; height: 100%; object-fit: cover;">
        </div>
        <div class="track-info-player">
          <p class="track-title-player" id="nowPlayingTitle">Aucune musique</p>
          <p class="track-artist" id="nowPlayingArtist">-</p>
        </div>
      </div>
    </div>
    <div class="player-main">
      <div class="progress-wrapper" id="progressWrapper">
        <div class="progress-bar" id="progressBar"></div>
        <div class="progress-handle" id="progressHandle"></div>
      </div>
      <div class="time-display">
        <span id="currentTime">0:00</span>
        <span id="totalTime">0:00</span>
      </div>
      <div class="player-buttons">
        <button class="btn btn-sm" title="Titre précédent" onclick="prevTrack()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="19 20 9 12 19 4 19 20"></polygon>
            <line x1="5" y1="19" x2="5" y2="5"></line>
          </svg>
        </button>
        <button class="btn btn-play btn-lg" id="playPauseBtn" title="Lecture/Pause" onclick="togglePlay()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="5 3 19 12 5 21 5 3"></polygon>
          </svg>
        </button>
        <button class="btn btn-sm" title="Titre suivant" onclick="nextTrack()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="5 4 15 12 5 20 5 4"></polygon>
            <line x1="19" y1="5" x2="19" y2="19"></line>
          </svg>
        </button>
      </div>
    </div>
    <div class="player-footer">
      <div class="player-volume">
        <button class="btn btn-sm" title="Volume">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
            <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
          </svg>
        </button>
        <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.8">
      </div>
      <div class="extras">
        <button class="btn btn-sm" id="loopBtn" title="Répéter" onclick="toggleLoop()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 2l4 4-4 4"></path>
            <path d="M3 11v-1a4 4 0 0 1 4-4h14"></path>
            <path d="M7 22l-4-4 4-4"></path>
            <path d="M21 13v1a4 4 0 0 1-4 4H3"></path>
          </svg>
        </button>
        <button class="btn btn-sm" id="shuffleBtn" title="Lecture aléatoire" onclick="toggleShuffle()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M16 3h5v5"></path>
            <path d="M4 20L21 3"></path>
            <path d="M21 16v5h-5"></path>
            <path d="M15 15l6 6"></path>
            <path d="M4 4l5 5"></path>
          </svg>
        </button>
        <button class="btn btn-sm" title="Partager" onclick="shareTrack()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="18" cy="5" r="3"></circle>
            <circle cx="6" cy="12" r="3"></circle>
            <circle cx="18" cy="19" r="3"></circle>
            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
          </svg>
        </button>
        <button class="btn btn-sm" title="Plein écran" onclick="enterFullscreenLed()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M8 3H5a2 2 0 0 0-2 2v3"></path>
            <path d="M21 8V5a2 2 0 0 0-2-2h-3"></path>
            <path d="M3 16v3a2 2 0 0 0 2 2h3"></path>
            <path d="M16 21h3a2 2 0 0 0 2-2v-3"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
  <!-- Mode plein écran LED -->
  <div id="fullscreenLed">
    <canvas class="led-canvas"></canvas>
    <div class="led-content">
      <img class="led-album" src="" alt="Album cover">
      <div class="led-title"></div>
      <div class="led-artist"></div>
      <button class="led-exit" onclick="exitFullscreenLed()">Quitter le plein écran</button>
    </div>
  </div>
  <audio id="mainAudio"></audio>
  <script>
    // --- Variables globales ---
    let musicData = [];
    let currentIndex = 0;
    let isLoop = false;
    let isShuffle = false;
    let audioCtx, analyser, source, dataArray;
    let audioCtxInitialized = false;
    let ledColors = [];

    const audio = document.getElementById('mainAudio');
    const progressBar = document.getElementById('progressBar');
    const progressHandle = document.getElementById('progressHandle');
    const currentTimeDisplay = document.getElementById('currentTime');
    const totalTimeDisplay = document.getElementById('totalTime');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const loopBtn = document.getElementById('loopBtn');
    const shuffleBtn = document.getElementById('shuffleBtn');
    const nowPlayingTitle = document.getElementById('nowPlayingTitle');
    const nowPlayingArtist = document.getElementById('nowPlayingArtist');
    const progressWrapper = document.getElementById('progressWrapper');
    const currentAlbumImage = document.getElementById('currentAlbumImage');

    // --- Extraction des couleurs dominantes ---
    function extractDominantColors(imageSrc, callback) {
      const img = new Image();
      img.crossOrigin = "Anonymous";
      img.src = imageSrc;
      img.onload = function() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0, img.width, img.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
        const colorMap = {};
        const sampleSize = 10;
        for (let i = 0; i < imageData.length; i += 4 * sampleSize) {
          const r = imageData[i];
          const g = imageData[i + 1];
          const b = imageData[i + 2];
          if (imageData[i + 3] < 200 || (r < 10 && g < 10 && b < 10) || (r > 245 && g > 245 && b > 245)) {
            continue;
          }
          const quantizedColor = `${Math.floor(r / 10) * 10},${Math.floor(g / 10) * 10},${Math.floor(b / 10) * 10}`;
          if (colorMap[quantizedColor]) {
            colorMap[quantizedColor].count++;
          } else {
            colorMap[quantizedColor] = { r: r, g: g, b: b, count: 1 };
          }
        }
        const sortedColors = Object.values(colorMap).sort((a, b) => b.count - a.count);
        const colorCount = Math.min(6, Math.max(3, Math.floor(sortedColors.length / 20)));
        const colors = [];
        for (let i = 0, added = 0; i < sortedColors.length && added < colorCount; i++) {
          const color = sortedColors[i];
          let isDifferent = true;
          for (let j = 0; j < colors.length; j++) {
            const existingColor = colors[j];
            const colorDistance = Math.sqrt(
              Math.pow(color.r - existingColor.r, 2) +
              Math.pow(color.g - existingColor.g, 2) +
              Math.pow(color.b - existingColor.b, 2)
            );
            if (colorDistance < 50) {
              isDifferent = false;
              break;
            }
          }
          if (isDifferent) {
            colors.push(color);
            added++;
          }
        }
        if (colors.length < 3) {
          colors.push({ r: 255, g: 255, b: 180 });
        }
        callback(colors);
      };
      img.onerror = function() {
        callback([
          { r: 255, g: 180, b: 0 },
          { r: 100, g: 200, b: 255 },
          { r: 255, g: 100, b: 200 },
          { r: 150, g: 255, b: 100 }
        ]);
      };
    }

    // --- Plein écran LED ---
    let ledAnimationId = null;
    function enterFullscreenLed() {
      const fs = document.getElementById('fullscreenLed');
      const cover = fs.querySelector('.led-album');
      const title = fs.querySelector('.led-title');
      const artist = fs.querySelector('.led-artist');
      cover.src = '/' + musicData[currentIndex].cover;
      title.textContent = musicData[currentIndex].title;
      artist.textContent = musicData[currentIndex].artist;
      fs.style.display = 'flex';
      document.body.style.overflow = 'hidden';

      // Extrait les couleurs dominantes de la cover
      extractDominantColors(cover.src, function(colors) {
        ledColors = colors;
        startLedAnimation();
      });
    }
    function exitFullscreenLed() {
      document.getElementById('fullscreenLed').style.display = 'none';
      document.body.style.overflow = '';
      stopLedAnimation();
    }
    function startLedAnimation() {
      const canvas = document.querySelector('.led-canvas');
      const ctx = canvas.getContext('2d');
      resizeLedCanvas();
      let leds = [];
      for (let i = 0; i < 30; i++) {
        const color = ledColors.length > 0 ? ledColors[Math.floor(Math.random() * ledColors.length)] : {r:255,g:255,b:255};
        leds.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          r: Math.random() * 40 + 30,
          dx: (Math.random() - 0.5) * 0.7,
          dy: (Math.random() - 0.5) * 0.7,
          color: `rgb(${color.r},${color.g},${color.b})`
        });
      }
      function getBass() {
        if (!audioCtxInitialized) return 0;
        analyser.getByteFrequencyData(dataArray);
        let sum = 0;
        for (let i = 0; i < 10; i++) sum += dataArray[i];
        return sum / 10;
      }
      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const bass = getBass();
        leds.forEach(led => {
          led.x += led.dx;
          led.y += led.dy;
          if (led.x < 0 || led.x > canvas.width) led.dx *= -1;
          if (led.y < 0 || led.y > canvas.height) led.dy *= -1;
          let radius = led.r * (1 + bass/200);
          ctx.beginPath();
          ctx.arc(led.x, led.y, radius, 0, 2 * Math.PI);
          ctx.fillStyle = led.color;
          ctx.globalAlpha = 0.25 + 0.5 * (bass/255);
          ctx.shadowBlur = 30;
          ctx.shadowColor = led.color;
          ctx.fill();
          ctx.globalAlpha = 1;
          ctx.shadowBlur = 0;
        });
        ledAnimationId = requestAnimationFrame(animate);
      }
      window.addEventListener('resize', resizeLedCanvas);
      animate();
    }
    function stopLedAnimation() {
      if (ledAnimationId) cancelAnimationFrame(ledAnimationId);
    }
    function resizeLedCanvas() {
      const canvas = document.querySelector('.led-canvas');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }

    // --- Session Storage ---
    const LAST_TRACK_KEY = "lastPlayedTrackIndex";
    const LAST_POSITION_KEY = "lastPlayedPosition";
    const LAST_VOLUME_KEY = "lastSetVolume";
    const LAST_LOOP_KEY = "lastLoop";
    const LAST_SHUFFLE_KEY = "lastShuffle";

    function saveCurrentMusicSession() {
      if (typeof currentIndex !== "undefined" && musicData[currentIndex]) {
        localStorage.setItem(LAST_TRACK_KEY, currentIndex.toString());
      }
      if (audio.currentTime > 0 && !isNaN(audio.currentTime) && audio.duration) {
        localStorage.setItem(LAST_POSITION_KEY, audio.currentTime.toString());
      }
      localStorage.setItem(LAST_VOLUME_KEY, audio.volume.toString());
      localStorage.setItem(LAST_LOOP_KEY, isLoop ? "1" : "0");
      localStorage.setItem(LAST_SHUFFLE_KEY, isShuffle ? "1" : "0");
    }
    function restoreMusicSession() {
      const savedTrackIndex = localStorage.getItem(LAST_TRACK_KEY);
      const savedPosition = localStorage.getItem(LAST_POSITION_KEY);
      const savedVolume = localStorage.getItem(LAST_VOLUME_KEY);
      const savedLoop = localStorage.getItem(LAST_LOOP_KEY);
      const savedShuffle = localStorage.getItem(LAST_SHUFFLE_KEY);

      if (savedTrackIndex !== null && musicData[savedTrackIndex]) {
        playTrack(Number(savedTrackIndex), false);
        if (savedPosition !== null) {
          audio.currentTime = parseFloat(savedPosition);
        }
      }
      if (savedVolume !== null) {
        audio.volume = parseFloat(savedVolume);
        document.getElementById('volumeSlider').value = savedVolume;
      }
      if (savedLoop !== null) {
        isLoop = savedLoop === "1";
        audio.loop = isLoop;
        loopBtn.classList.toggle('active', isLoop);
      }
      if (savedShuffle !== null) {
        isShuffle = savedShuffle === "1";
        shuffleBtn.classList.toggle('active', isShuffle);
      }
    }
    audio.addEventListener('play', () => setTimeout(saveCurrentMusicSession, 1000));
    audio.addEventListener('pause', saveCurrentMusicSession);
    audio.addEventListener('volumechange', saveCurrentMusicSession);
    audio.addEventListener('timeupdate', () => {
      if (!audio.paused && audio.currentTime > 0) saveCurrentMusicSession();
    });
    window.addEventListener('beforeunload', saveCurrentMusicSession);

    // --- AudioContext pour l'analyseur (bass) ---
    function initAudioContext() {
      if (!audioCtxInitialized) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser();
        source = audioCtx.createMediaElementSource(audio);
        source.connect(analyser);
        analyser.connect(audioCtx.destination);
        analyser.fftSize = 128;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        audioCtxInitialized = true;
      }
    }

    // --- Player logic ---
    function playTrack(index, autoPlay = true) {
      if (!musicData[index]) return;
      currentIndex = index;
      audio.src = '/' + musicData[index].src;
      nowPlayingTitle.textContent = musicData[index].title;
      nowPlayingArtist.textContent = musicData[index].artist;
      currentAlbumImage.src = '/' + musicData[index].cover;
      updatePlayPauseButton(true);
      if (autoPlay) {
        if (!audioCtxInitialized) initAudioContext();
        audio.play().catch(() => {});
        updatePlayPauseButton(false);
      }
    }
    function togglePlay() {
      if (!audioCtxInitialized) initAudioContext();
      if (!audio.src) return;
      if (audio.paused) {
        audio.play().catch(err => {
          alert("Lecture bloquée par le navigateur. Cliquez à nouveau ou vérifiez les permissions.");
        });
        updatePlayPauseButton(false);
      } else {
        audio.pause();
        updatePlayPauseButton(true);
      }
    }
    function updatePlayPauseButton(isPaused) {
      if (isPaused) {
        playPauseBtn.innerHTML = `
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="5 3 19 12 5 21 5 3"></polygon>
          </svg>
        `;
      } else {
        playPauseBtn.innerHTML = `
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="6" y="4" width="4" height="16"></rect>
            <rect x="14" y="4" width="4" height="16"></rect>
          </svg>
        `;
      }
    }
    function prevTrack() {
      currentIndex = isShuffle ? Math.floor(Math.random() * musicData.length) : (currentIndex - 1 + musicData.length) % musicData.length;
      playTrack(currentIndex);
    }
    function nextTrack() {
      currentIndex = isShuffle ? Math.floor(Math.random() * musicData.length) : (currentIndex + 1) % musicData.length;
      playTrack(currentIndex);
    }
    function toggleLoop() {
      isLoop = !isLoop;
      audio.loop = isLoop;
      loopBtn.classList.toggle('active', isLoop);
      saveCurrentMusicSession();
    }
    function toggleShuffle() {
      isShuffle = !isShuffle;
      shuffleBtn.classList.toggle('active', isShuffle);
      saveCurrentMusicSession();
    }
    function shareTrack() {
      if (!musicData[currentIndex]) return;
      const title = musicData[currentIndex].title;
      navigator.clipboard.writeText(`${window.location.origin}/music?track=${encodeURIComponent(title)}`);
      alert('Lien de partage copié !');
    }
    function updateProgress() {
      const progress = (audio.currentTime / audio.duration) * 100 || 0;
      progressBar.style.width = `${progress}%`;
      progressHandle.style.left = `${progress}%`;
      currentTimeDisplay.textContent = formatTime(audio.currentTime);
      totalTimeDisplay.textContent = formatTime(audio.duration);
    }
    function formatTime(seconds) {
      if (isNaN(seconds)) return "0:00";
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }
    progressWrapper.addEventListener('click', (e) => {
      if (!audio.src) return;
      const rect = progressWrapper.getBoundingClientRect();
      const pos = (e.clientX - rect.left) / rect.width;
      audio.currentTime = pos * audio.duration;
    });
    document.getElementById('searchInput').addEventListener('input', e => {
      const q = e.target.value.toLowerCase();
      const filtered = musicData.filter(t =>
        `${t.title} ${t.artist} ${t.album} ${t.style}`.toLowerCase().includes(q)
      );
      renderTracks(filtered);
    });
    document.getElementById('volumeSlider').addEventListener('input', e => {
      audio.volume = parseFloat(e.target.value);
      saveCurrentMusicSession();
    });
    audio.addEventListener('ended', () => {
      if (!audio.loop) nextTrack();
    });
    audio.addEventListener('timeupdate', updateProgress);
    audio.addEventListener('error', () => {
      alert("Erreur lors du chargement du fichier audio.");
    });
    function renderTracks(tracks) {
      const list = document.getElementById('trackList');
      list.innerHTML = '';
      tracks.forEach((track, index) => {
        const actualIndex = musicData.findIndex(t =>
          t.title === track.title && t.artist === track.artist && t.album === track.album
        );
        const card = document.createElement('div');
        card.className = 'track';
        card.onclick = () => {
          playTrack(actualIndex);
        };
        card.innerHTML = `
          <img src="/${track.cover}" alt="Cover">
          <div class="track-info">
            <p>Artiste : ${track.artist}</p>
            <p>Album : ${track.album || 'Single'}</p>
            <p>Style : ${track.style}</p>
          </div>
          <div class="track-title">${track.title}</div>
        `;
        list.appendChild(card);
      });
    }
    async function fetchMusic() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const sharedTrack = urlParams.get('track');

        const res = await fetch('/music/metadata.json');
        musicData = await res.json();

        // Filtrer les musiques accessibles uniquement si elles ne sont pas bloquées par un contrôle de paiement
        musicData = musicData.filter(track => !track.paid || track.accessible);

        renderTracks(musicData);

        if (sharedTrack) {
          const sharedIndex = musicData.findIndex(track => track.title.toLowerCase() === sharedTrack.toLowerCase());
          if (sharedIndex !== -1) {
            playTrack(sharedIndex);
          }
        } else {
          restoreMusicSession();
        }
      } catch (error) {
        musicData = [
          { title: "Bohemian Rhapsody", artist: "Queen", album: "A Night at the Opera", style: "Rock", cover: "default-cover.jpg", src: "music/song1.mp3" },
          { title: "Billie Jean", artist: "Michael Jackson", album: "Thriller", style: "Pop", cover: "default-cover.jpg", src: "music/song2.mp3" },
          { title: "Imagine", artist: "John Lennon", album: "Imagine", style: "Rock", cover: "default-cover.jpg", src: "music/song3.mp3" }
        ];
        renderTracks(musicData);
        restoreMusicSession();
      }
    }
    fetchMusic();
  </script>
  <script>
    function saveToHistory(track) {
      let history = JSON.parse(localStorage.getItem('musicHistory') || '[]');
      history = history.filter(item => item.title !== track.title); // Éviter les doublons
      history.unshift(track); // Ajouter au début
      if (history.length > 200) history.pop(); // Limiter à 200 entrées
      localStorage.setItem('musicHistory', JSON.stringify(history));
    }
  
    function playTrack(index, autoPlay = true) {
      if (!musicData[index]) return;
      currentIndex = index;
      audio.src = '/' + musicData[index].src;
      nowPlayingTitle.textContent = musicData[index].title;
      nowPlayingArtist.textContent = musicData[index].artist;
      currentAlbumImage.src = '/' + musicData[index].cover;
  
      // Enregistrer la musique dans l'historique
      saveToHistory(musicData[index]);
  
      updatePlayPauseButton(true);
      if (autoPlay) {
        if (!audioCtxInitialized) initAudioContext();
        audio.play().catch(() => {});
        updatePlayPauseButton(false);
      }
    }
  </script>
</body>
</html>